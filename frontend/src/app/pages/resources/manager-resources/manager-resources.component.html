<div class="team-details-container">
  
  <!-- Navigation Bar -->
  <nav class="top-navbar">
    <div class="navbar-left">
      <button class="sidebar-toggle" (click)="toggleSidebar()">
        <i class="pi pi-bars"></i>
      </button>
      <img src="logo.png" alt="TRAM Logo" class="navbar-logo">
      <span class="navbar-title">TRAM Dashboard</span>
      <div class="project-switcher-nav">
        <button class="project-switcher-btn" (click)="toggleProjectSwitcher()">
          <i class="pi pi-th-large"></i>
          <span>{{ team?.name || 'Select Project' }}</span>
          <i class="pi pi-angle-down"></i>
        </button>
      </div>
    </div>
    <div class="navbar-right">
      <button class="nav-btn" (click)="openSharedDocuments()" title="Shared Documents">
        <i class="pi pi-share-alt"></i>
        <span>Shared Documents</span>
      </button>
      
      <div class="notification-container">
        <button class="nav-btn" (click)="toggleNotifications()" title="Notifications">
          <i class="pi pi-bell"></i>
          <span class="notification-badge" *ngIf="unreadNotificationCount > 0">{{ unreadNotificationCount }}</span>
        </button>
        
        <div class="notification-dropdown" *ngIf="showNotifications">
          <div class="notification-header">
            <h4>Notifications</h4>
            <button class="close-notifications" (click)="showNotifications = false">√ó</button>
          </div>
          <div class="notification-list">
            <div class="notification-item" *ngFor="let notification of notifications.slice(0, 5)" 
                 [class.unread]="!notification.isRead"
                 (click)="markNotificationAsRead(notification.id)">
              <div class="notification-content">
                <h5>{{ notification.title }}</h5>
                <p>{{ notification.message }}</p>
                <span class="notification-time">{{ notification.createdAt | date:'short' }}</span>
              </div>
            </div>
            <div class="no-notifications" *ngIf="notifications.length === 0">
              <p>No notifications</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="user-profile-container">
        <button class="nav-btn user-profile-btn" (click)="toggleUserDropdown()" title="User Profile">
          <i class="pi pi-user"></i>
          <span>{{ currentUsername }}</span>
        </button>
        
        <div class="user-dropdown" *ngIf="showUserDropdown">
          <div class="user-dropdown-header">
            <div class="user-avatar-dropdown">
              {{ currentUsername.charAt(0).toUpperCase() }}
            </div>
            <div class="user-info-dropdown">
              <h4>{{ currentUsername }}</h4>
              <p>{{ getCurrentUserEmail() }}</p>
              <span class="user-role-badge">{{ getCurrentUserRole() }}</span>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-menu-items">
            <button class="dropdown-item" (click)="openProfileSettings()">
              <i class="pi pi-cog"></i>
              <span>Profile Settings</span>
            </button>
            <button class="dropdown-item logout-item" (click)="logout()">
              <i class="pi pi-sign-out"></i>
              <span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
  
  <!-- Content wrapper for sidebar and main content -->
  <div class="content-wrapper">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" [class.hidden]="sidebarHidden" [class.collapsed]="sidebarHidden">
    <div class="sidebar-header">
      <div class="team-info">
        <div class="team-header-row">
          <h2>{{ team?.name }}</h2>
        </div>
        <div class="status-container">
          <span class="team-status" [class]="getStatusClass(team?.status || '')">
            {{ team?.status }}
          </span>
        </div>
      </div>
    </div>
      
      <nav class="sidebar-nav">
        <button class="nav-item" (click)="setActiveTab('overview')">
          <i class="pi pi-home"></i>
          <span>Overview</span>
        </button>
        <button class="nav-item" (click)="setActiveTab('members')">
          <i class="pi pi-users"></i>
          <span>Members</span>
        </button>
        <div class="nav-section-header">
          <span>RESOURCES</span>
        </div>
        <button class="nav-item" (click)="navigateToCommonResources()">
          <i class="pi pi-folder-open"></i>
          <span>Common Resources</span>
        </button>
        <button class="nav-item active">
          <i class="pi pi-lock"></i>
          <span>Controlled Resources</span>
        </button>
        <div class="nav-separator"></div>
        <button class="nav-item" (click)="setActiveTab('requests')">
          <i class="pi pi-key"></i>
          <span>Access Requests</span>
        </button>
        <button class="nav-item" (click)="setActiveTab('uploads')">
          <i class="pi pi-upload"></i>
          <span>My Uploads</span>
        </button>
        <button 
          *ngIf="isManagerOrAdminOnly()"
          class="nav-item"
          (click)="setActiveTab('create-project')"
        >
          <i class="pi pi-plus"></i>
          <span>Create Project</span>
        </button>
        <button 
          *ngIf="isManagerOrAdmin()"
          class="nav-item"
          (click)="setActiveTab('audit')"
        >
          <i class="pi pi-chart-line"></i>
          <span>Audit Log</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content" [class.expanded]="sidebarHidden">
      <header class="content-header">
        <div class="header-left">
          <h1>Controlled Resources</h1>
          <p>Resources requiring approval for access ({{ resources.length }} resources)</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" (click)="openAddResourceModal()">
            <i class="pi pi-plus"></i> Add Resource
          </button>
        </div>
      </header>

      <div class="tab-content">
        <div class="filters-section">
    <div class="search-bar">
      <input type="text" 
             [(ngModel)]="searchTerm" 
             (input)="onSearch()" 
             placeholder="Search resources..." 
             class="search-input">
      <i class="pi pi-search search-icon"></i>
    </div>
    
    <div class="access-filter-panel">
      <div class="filter-switch-group">
        <button class="filter-switch" 
                [class.active]="accessFilter === 'all'"
                (click)="setAccessFilter('all')">
          <i class="pi pi-list"></i> All
        </button>
        <button class="filter-switch" 
                [class.active]="accessFilter === 'locked'"
                (click)="setAccessFilter('locked')">
          <i class="pi pi-lock"></i> Locked
        </button>
        <button class="filter-switch" 
                [class.active]="accessFilter === 'pending'"
                (click)="setAccessFilter('pending')">
          <i class="pi pi-clock"></i> Pending
        </button>
        <button class="filter-switch" 
                [class.active]="accessFilter === 'open'"
                (click)="setAccessFilter('open')">
          <i class="pi pi-unlock"></i> Open
        </button>
      </div>
    </div>
    
    <div class="filter-controls">
      <select [(ngModel)]="selectedType" (change)="onSearch()" class="filter-select">
        <option value="">All Types</option>
        <option *ngFor="let type of getUniqueTypes()" [value]="type">{{ type }}</option>
      </select>
      
      <select [(ngModel)]="selectedCategory" (change)="onSearch()" class="filter-select">
        <option value="">All Categories</option>
        <option *ngFor="let category of getUniqueCategories()" [value]="category">{{ category }}</option>
      </select>
    </div>
  </div>

  <div class="resources-grid" *ngIf="!loading">
    <div class="resource-card" *ngFor="let resource of paginatedResources">
      <div class="resource-header">
        <div class="resource-title-section">
          <i class="file-icon {{ getFileIcon(resource) }}"></i>
          <h3>{{ resource.name }}</h3>
        </div>
        <div class="resource-tags">
          <span class="resource-type manager-controlled">{{ resource.type }}</span>
          <span class="resource-category">{{ resource.category || 'OTHER' }}</span>
        </div>
      </div>
      <p class="resource-description">{{ resource.description }}</p>
      
      <!-- File metadata display -->
      <div class="resource-metadata" *ngIf="resource.filePath || resource.resourceUrl || resource.fileData">
        <div class="metadata-item" *ngIf="resource.resourceUrl && hasApprovedAccess(resource)">
          <span class="metadata-label">üîó URL:</span>
          <a [href]="resource.resourceUrl" target="_blank" class="resource-link">
            {{ resource.resourceUrl.length > 50 ? (resource.resourceUrl | slice:0:50) + '...' : resource.resourceUrl }}
          </a>
        </div>
        <div class="metadata-item" *ngIf="resource.resourceUrl && !hasApprovedAccess(resource)">
          <span class="metadata-label">üîó URL:</span>
          <span class="locked-content">üîí Access Required</span>
        </div>
        <div class="metadata-item" *ngIf="(resource.filePath || resource.fileData) && hasApprovedAccess(resource)">
          <span class="metadata-label">üìÅ File:</span>
          <span class="file-path">{{ resource.filePath ? resource.filePath.split('/').pop() : 'Database File' }}</span>
        </div>
        <div class="metadata-item" *ngIf="(resource.filePath || resource.fileData) && !hasApprovedAccess(resource)">
          <span class="metadata-label">üìÅ File:</span>
          <span class="locked-content">üîí Access Required</span>
        </div>
        <div class="metadata-item" *ngIf="resource.fileSize && hasApprovedAccess(resource)">
          <span class="metadata-label">üìä Size:</span>
          <span class="file-size">{{ formatFileSize(resource.fileSize) }}</span>
        </div>
      </div>
      
      <div class="resource-actions">
        <!-- Manager/Admin Actions -->
        <ng-container *ngIf="isManagerOrAdmin()">
          <button class="btn btn-sm btn-primary" 
                  *ngIf="canViewFile(resource)" 
                  (click)="viewFile(resource)">
            <i class="pi pi-eye"></i> View
          </button>
          <button class="btn btn-sm btn-secondary" 
                  *ngIf="resource.filePath || resource.fileData" 
                  (click)="downloadFile(resource)">
            <i class="pi pi-download"></i> Download
          </button>
          <button class="btn btn-sm btn-info" 
                  (click)="showResourceAccess(resource)">
            <i class="pi pi-users"></i> Access
          </button>
        </ng-container>
        
        <!-- Team Member Actions -->
        <ng-container *ngIf="!isManagerOrAdmin()">
          <!-- Show access buttons if user has approved access -->
          <ng-container *ngIf="hasApprovedAccess(resource)">
            <button class="btn btn-sm btn-primary" 
                    *ngIf="canViewFile(resource)" 
                    (click)="viewFile(resource)">
              <i class="pi pi-eye"></i> View
            </button>
            <button class="btn btn-sm btn-secondary" 
                    *ngIf="resource.filePath || resource.fileData" 
                    (click)="downloadFile(resource)">
              <i class="pi pi-download"></i> Download
            </button>
            <span class="access-status owner" *ngIf="isResourceCreator(resource)">
              <i class="pi pi-user"></i> Owner
            </span>
            <span class="access-status approved" *ngIf="!isResourceCreator(resource)">
              <i class="pi pi-check"></i> Access Granted
            </span>
          </ng-container>
          
          <!-- Show pending status if request is pending -->
          <ng-container *ngIf="hasPendingRequest(resource) && !hasApprovedAccess(resource)">
            <span class="access-status pending"><i class="pi pi-clock"></i> Request Pending</span>
          </ng-container>
          
          <!-- Show request access button if no request exists -->
          <ng-container *ngIf="!hasPendingRequest(resource) && !hasApprovedAccess(resource)">
            <button class="btn btn-sm btn-warning" 
                    (click)="openRequestAccessModal(resource)">
              <i class="pi pi-lock"></i> Request Access
            </button>
          </ng-container>
        </ng-container>
      </div>
      
      <div class="resource-meta">
        <span class="access-required" *ngIf="!isResourceCreator(resource) && !isManagerOrAdmin() && !hasApprovedAccess(resource)">Approval Required</span>
        <span class="owner-badge" *ngIf="isResourceCreator(resource)">Your Upload</span>
      </div>
    </div>
  </div>

  <div class="pagination" *ngIf="totalPages > 1">
    <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
      <i class="pi pi-chevron-left"></i>
    </button>
    <span class="page-info">{{ currentPage }} of {{ totalPages }}</span>
    <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
      <i class="pi pi-chevron-right"></i>
    </button>
  </div>

  <div class="loading" *ngIf="loading">Loading resources...</div>
    <div class="empty-state" *ngIf="!loading && paginatedResources.length === 0">
      <h3>No resources found</h3>
      <p>No controlled resources match your current filters.</p>
    </div>
      </div>
    </div>
  </div>
</div>

<!-- Project Switcher Modal -->
<div class="project-switcher-overlay" *ngIf="showProjectSwitcher" (click)="closeProjectSwitcher()">
  <div class="project-switcher-modal" (click)="$event.stopPropagation()">
    <div class="switcher-header">
      <h3>Switch Project</h3>
      <button class="close-switcher" (click)="closeProjectSwitcher()">√ó</button>
    </div>
    <div class="projects-grid">
      <div class="project-card" 
           *ngFor="let project of allProjects" 
           [class.current]="project.id === teamId"
           (click)="selectProject(project.id)">
        <div class="project-icon">
          <i class="pi pi-folder"></i>
        </div>
        <div class="project-info">
          <h4>{{ project.name }}</h4>
          <p>{{ project.description }}</p>
        </div>
        <div class="project-status" [class]="getStatusClass(project.status)">{{ project.status }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Add Resource Modal -->
<div class="modal-overlay" *ngIf="showAddResourceModal" (click)="closeAddResourceModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Controlled Resource</h3>
      <button class="close-btn" (click)="closeAddResourceModal()">√ó</button>
    </div>
    
    <form [formGroup]="addResourceForm" (ngSubmit)="onAddResource()">
      <div class="form-group">
        <label>Resource Name *</label>
        <input type="text" formControlName="name" class="form-control">
      </div>
      
      <div class="form-group">
        <label>Description *</label>
        <textarea formControlName="description" class="form-control" rows="3"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Type *</label>
          <div class="select-wrapper">
            <select formControlName="type" class="form-control">
              <option value="DATABASE">Database</option>
              <option value="API">API</option>
            <option value="REST_API">REST API</option>
            <option value="GRAPHQL_API">GraphQL API</option>
            <option value="SERVICE">Service</option>
            <option value="TOOL">Tool</option>
            <option value="PDF">PDF</option>
            <option value="DOC">DOC</option>
            <option value="DOCX">DOCX</option>
            <option value="XLS">XLS</option>
            <option value="XLSX">XLSX</option>
            <option value="PPT">PPT</option>
            <option value="PPTX">PPTX</option>
            <option value="TXT">TXT</option>
            <option value="JPG">JPG</option>
            <option value="JPEG">JPEG</option>
            <option value="PNG">PNG</option>
            <option value="GIF">GIF</option>
            <option value="MP4">MP4</option>
            <option value="AVI">AVI</option>
            <option value="MOV">MOV</option>
            <option value="MP3">MP3</option>
            <option value="WAV">WAV</option>
            <option value="ZIP">ZIP</option>
            <option value="RAR">RAR</option>
            <option value="JAVA">JAVA</option>
            <option value="JAVASCRIPT">JavaScript</option>
            <option value="PYTHON">Python</option>
            <option value="HTML">HTML</option>
            <option value="CSS">CSS</option>
            <option value="XML">XML</option>
            <option value="JSON">JSON</option>
            <option value="YAML">YAML</option>
            <option value="SQL">SQL</option>
            <option value="GITHUB_LINK">GitHub Link</option>
            <option value="GITLAB_LINK">GitLab Link</option>
            <option value="URL">URL</option>
            <option value="CLOUD_SERVICE">Cloud Service</option>
            <option value="AWS_S3">AWS S3</option>
            <option value="GOOGLE_DRIVE">Google Drive</option>
            <option value="DROPBOX">Dropbox</option>
            <option value="OTHER">Other</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Category *</label>
          <div class="select-wrapper">
            <select formControlName="category" class="form-control">
            <option value="DATABASE">Database Resources</option>
            <option value="API">API Resources</option>
            <option value="DOCUMENTATION">Documentation</option>
            <option value="REPOSITORY">Code Repositories</option>
            <option value="EXTERNAL_LINKS">External Links</option>
            <option value="CLOUD_SERVICES">Cloud Services</option>
            <option value="DOCUMENTS">Documents</option>
            <option value="IMAGES">Images</option>
            <option value="VIDEOS">Videos</option>
            <option value="AUDIO">Audio Files</option>
            <option value="ARCHIVES">Archive Files</option>
            <option value="CODE_FILES">Code Files</option>
            <option value="MEDIA">Media Files</option>
            <option value="OTHER">Other Resources</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="upload-mode-selector">
        <button type="button" class="mode-btn" [class.active]="uploadMode === 'url'" (click)="setUploadMode('url')">
          <i class="pi pi-link"></i> URL
        </button>
        <button type="button" class="mode-btn" [class.active]="uploadMode === 'file'" (click)="setUploadMode('file')">
          <i class="pi pi-upload"></i> File
        </button>
      </div>
      
      <div class="form-group" *ngIf="uploadMode === 'url'">
        <label>Resource URL *</label>
        <input type="url" formControlName="resourceUrl" class="form-control">
      </div>
      
      <div class="form-group" *ngIf="uploadMode === 'file'">
        <label>Select File *</label>
        <input type="file" (change)="onFileSelected($event)" class="form-control">
      </div>
      
      <div class="form-group">
        <label for="allowedUserGroups">Allowed User Groups</label>
        <div class="select-wrapper">
          <select id="allowedUserGroups" formControlName="allowedUserGroups" class="form-control">
            <option value="">Select user groups (optional)</option>
            <option value="dev">dev</option>
            <option value="test">test</option>
            <option value="QA">QA</option>
          </select>
        </div>
        <div class="form-help">Select user groups that can access this resource automatically. Leave empty for manager approval required.</div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeAddResourceModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="addResourceForm.invalid">Add Resource</button>
      </div>
    </form>
  </div>
</div>

<!-- Resource Access Modal -->
<div class="modal-overlay" *ngIf="showResourceAccessModal" (click)="closeResourceAccessModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Resource Access - {{ selectedResource?.name }}</h3>
      <button class="close-btn" (click)="closeResourceAccessModal()">√ó</button>
    </div>
    
    <div class="access-content">

      
      <div class="loading" *ngIf="loadingResourceAccess">Loading access information...</div>
      
      <div class="access-info" *ngIf="!loadingResourceAccess">
        <!-- Always show user groups section for controlled resources -->
        <div class="user-groups-section">
          <h4><i class="pi pi-users"></i> Allowed User Groups</h4>
          <div class="group-badges">
            <span class="group-badge">
              <i class="pi pi-check-circle"></i> {{ selectedResource?.allowedUserGroups || 'dev' }} users
            </span>
          </div>
          <p class="groups-description">Users from these groups have automatic access to this resource.</p>
        </div>
        
        <div class="users-section">
          <h4>Individual Access</h4>
          
          <div class="access-table-container" *ngIf="resourceAccess.length > 0; else noAccessUsers">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Access Level</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let access of resourceAccess" class="table-row">
                  <td>{{ access.username }}</td>
                  <td><span class="access-level-badge">{{ access.accessLevel }}</span></td>
                  <td><span class="status-badge granted">Access Granted</span></td>
                  <td class="actions-cell">
                    <button *ngIf="isManagerOrAdmin() && access.username !== currentUsername" 
                            class="btn btn-sm btn-danger" 
                            (click)="revokeUserAccess(access.userId)" 
                            title="Revoke Access">
                      <i class="pi pi-times"></i> Revoke
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <ng-template #noAccessUsers>
            <div class="empty-state">
              <p><i class="pi pi-users"></i> No individual users have been granted access.</p>
              <p>Users from the groups above have automatic access to this resource.</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Request Access Modal -->
<div class="modal-overlay" *ngIf="showRequestAccessModal" (click)="closeRequestAccessModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Request Access - {{ selectedResource?.name }}</h3>
      <button class="close-btn" (click)="closeRequestAccessModal()">√ó</button>
    </div>
    
    <form [formGroup]="requestAccessForm" (ngSubmit)="onRequestAccess()">
      <div class="resource-info">
        <p><strong>Resource:</strong> {{ selectedResource?.name }}</p>
        <p><strong>Description:</strong> {{ selectedResource?.description }}</p>
        <p><strong>Type:</strong> {{ selectedResource?.type }}</p>
      </div>
      
      <div class="form-group">
        <label for="justification">Justification *</label>
        <textarea id="justification" 
                  formControlName="justification" 
                  class="form-control" 
                  rows="4" 
                  placeholder="Please explain why you need access to this resource"></textarea>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeRequestAccessModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="requestAccessForm.invalid">
          Submit Request
        </button>
      </div>
    </form>
  </div>
</div>